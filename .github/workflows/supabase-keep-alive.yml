name: Keep Supabase Active

# Run every 5 days to prevent Supabase from pausing after 7 days of inactivity
on:
   schedule:
      # Runs at 03:00 UTC every 5 days
      - cron: "0 3 */5 * *"
   # Allow manual trigger for testing
   workflow_dispatch:

jobs:
   keep-alive:
      runs-on: ubuntu-latest

      steps:
         - name: Checkout repository
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: "20"

         - name: Install Supabase Client
           run: npm install @supabase/supabase-js

         - name: Ping Supabase Database Directly
           env:
              SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
              SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
           run: |
              node -e "
              const { createClient } = require('@supabase/supabase-js');

              const supabaseUrl = process.env.SUPABASE_URL;
              const supabaseKey = process.env.SUPABASE_ANON_KEY;

              if (!supabaseUrl || !supabaseKey) {
                console.error('âŒ Missing Supabase credentials in GitHub Secrets');
                console.log('Required secrets: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY');
                process.exit(1);
              }

              const supabase = createClient(supabaseUrl, supabaseKey);

              (async () => {
                try {
                  console.log('ðŸ”„ Pinging Supabase database...');
                  console.log('ðŸ“ URL:', supabaseUrl.substring(0, 30) + '...');
                  
                  // Perform a lightweight query on clients table (definitely exists in your schema)
                  const { data, error } = await supabase
                    .from('clients')
                    .select('id', { count: 'exact', head: true })
                    .limit(1);
                  
                  if (error) {
                    console.error('âŒ Supabase query failed:', error.message);
                    console.error('Error details:', JSON.stringify(error, null, 2));
                    process.exit(1);
                  }
                  
                  console.log('âœ… Supabase keep-alive successful!');
                  console.log('ðŸ“Š Query executed at:', new Date().toISOString());
                  console.log('ðŸŽ¯ Database is active and will not auto-pause');
                  console.log('â° Next scheduled run: in 5 days');
                } catch (err) {
                  console.error('âŒ Unexpected error:', err.message);
                  console.error('Stack:', err.stack);
                  process.exit(1);
                }
              })();
              "

         - name: Send notification on failure
           if: failure()
           run: |
              echo "================================================"
              echo "âš ï¸  SUPABASE KEEP-ALIVE FAILED!"
              echo "================================================"
              echo ""
              echo "Required GitHub Secrets:"
              echo "  â€¢ NEXT_PUBLIC_SUPABASE_URL"
              echo "  â€¢ NEXT_PUBLIC_SUPABASE_ANON_KEY"
              echo ""
              echo "Troubleshooting:"
              echo "  1. Verify secrets are set in GitHub repo settings"
              echo "  2. Check if Supabase project is already paused"
              echo "  3. Verify anon key has read access to 'clients' table"
              echo "  4. Test manually by clicking 'Run workflow'"
              echo ""
              echo "================================================"

         - name: Log Execution
           if: always()
           run: |
              echo ""
              echo "================================================"
              echo "ðŸ“ Execution Summary"
              echo "================================================"
              echo "Workflow executed at: $(date)"
              echo "Next scheduled run: $(date -v +5d 2>/dev/null || date -d '+5 days' 2>/dev/null || echo 'in 5 days')"
              echo "Status: ${{ job.status }}"
              echo "================================================"
